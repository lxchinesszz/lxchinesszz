import{_ as n,o as a,c as p,a4 as e}from"./chunks/framework.B8fosacB.js";const u=JSON.parse('{"title":"海量数据模拟","description":"","frontmatter":{"breadcrumb":false,"navbar":true,"sidebar":true,"pageInfo":true,"contributor":true,"editLink":true,"updateTime":true,"prev":true,"next":true,"comment":false,"footer":true,"backtotop":true,"title":"海量数据模拟","category":"SQL优化"},"headers":[],"relativePath":"post/java/sql/海量数据模拟.md","filePath":"post/java/sql/海量数据模拟.md","lastUpdated":1731158524000}'),l={name:"post/java/sql/海量数据模拟.md"};function i(r,s,t,c,b,h){return a(),p("div",{"data-pagefind-body":!0},s[0]||(s[0]=[e(`<p><img src="https://img.springlearn.cn/learn_c87a079fcea0d7893b03d4d57478bca7.png" alt=""></p><p><strong>作者</strong>: 西魏陶渊明 <strong>博客</strong>: <a href="https://blog.springlearn.cn/" target="_blank" rel="noreferrer">https://blog.springlearn.cn/</a></p><div class="tip custom-block"><p class="custom-block-title">西魏陶渊明</p><p>莫笑少年江湖梦，谁不少年梦江湖</p></div><h2 id="一、创建表" tabindex="-1">一、创建表 <a class="header-anchor" href="#一、创建表" aria-label="Permalink to &quot;一、创建表&quot;">​</a></h2><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">create</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> table</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> dept</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dno </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">primary key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dname </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">not null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> loc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) engine </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">innodb </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> charset</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">utf8;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">create</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> table</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> emp</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> eid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">primary key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ename </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">not null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> job </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">not null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> deptno </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">not null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) engine </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">innodb </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  charset</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">utf8;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="二、存储函数插入海量数量" tabindex="-1">二、存储函数插入海量数量 <a class="header-anchor" href="#二、存储函数插入海量数量" aria-label="Permalink to &quot;二、存储函数插入海量数量&quot;">​</a></h2><p>存储过程无return,存储函数有。</p><h3 id="_1-创建存储函数生成id和name" tabindex="-1">1. 创建存储函数生成id和name <a class="header-anchor" href="#_1-创建存储函数生成id和name" aria-label="Permalink to &quot;1. 创建存储函数生成id和name&quot;">​</a></h3><p>name随机字符串</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>delimiter $</span></span>
<span class="line"><span>create function randstring(n int) returns varchar(255)</span></span>
<span class="line"><span>begin </span></span>
<span class="line"><span>    declare all_str varchar(100) default &#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;;</span></span>
<span class="line"><span>    declare return_str varchar(255) default &#39;&#39;;</span></span>
<span class="line"><span>    declare i int default 0;</span></span>
<span class="line"><span>    while i &lt;n</span></span>
<span class="line"><span>    do</span></span>
<span class="line"><span>        set return_str = concat(return_str,substring(all_str,rand()*52,1));</span></span>
<span class="line"><span>        set i = i+1;</span></span>
<span class="line"><span>    end while;    </span></span>
<span class="line"><span>    return return_str;</span></span>
<span class="line"><span>end $</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>ERROR 1418 (HY000): This function has none of DETERMINISTIC, NO SQL, or READS SQL DATA in its declaration and binary logging is enabled (you *might* want to use the less safe log_bin_trust_function_creators variable)</code></p><p>如果开启了慢慢查询日志,在开启存储函数就会冲突,解决办法1就是管理慢日志查询。</p><p>解决办法2:</p><p><code>show variables like &#39;%log_bin_trust_function_creators%&#39;;</code></p><p><code>set global log_bin_trust_function_creators=1;</code></p><p>id随机数</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>delimiter $</span></span>
<span class="line"><span>create function rand_num()returns int(5)</span></span>
<span class="line"><span>begin</span></span>
<span class="line"><span>    declare i int default 0;</span></span>
<span class="line"><span>    set i = floor(rand() * 100);</span></span>
<span class="line"><span>    return i;</span></span>
<span class="line"><span>end $;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_2-通过存储过程插入海量数据emp" tabindex="-1">2. 通过存储过程插入海量数据emp <a class="header-anchor" href="#_2-通过存储过程插入海量数据emp" aria-label="Permalink to &quot;2. 通过存储过程插入海量数据emp&quot;">​</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>create procedure insert_emp(in eid_start int(10),in data_times int(10))</span></span>
<span class="line"><span>begin</span></span>
<span class="line"><span>    declare i int default 0;</span></span>
<span class="line"><span>    set autocommit = 0;</span></span>
<span class="line"><span>    repeat</span></span>
<span class="line"><span>        insert into emp values(eid_start + i,randstring(5),&#39;other&#39;,rand_num());</span></span>
<span class="line"><span>        set i = i + 1;</span></span>
<span class="line"><span>        until i = data_times</span></span>
<span class="line"><span>    end repeat;   </span></span>
<span class="line"><span>    commit;</span></span>
<span class="line"><span>end $;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_2-通过存储过程插入海量数据dept" tabindex="-1">2. 通过存储过程插入海量数据dept <a class="header-anchor" href="#_2-通过存储过程插入海量数据dept" aria-label="Permalink to &quot;2. 通过存储过程插入海量数据dept&quot;">​</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>create procedure insert_dept(in dno_start int(10),in data_times int(10))</span></span>
<span class="line"><span>begin</span></span>
<span class="line"><span>    declare i int default 0;</span></span>
<span class="line"><span>    set autocommit = 0;</span></span>
<span class="line"><span>    repeat</span></span>
<span class="line"><span>        insert into dept values(dno_start+i,randstring(6),randstring(8));</span></span>
<span class="line"><span>        set i = i + 1;</span></span>
<span class="line"><span>        until i = data_times</span></span>
<span class="line"><span>    end repeat;</span></span>
<span class="line"><span>commit;</span></span>
<span class="line"><span>end$</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_3-插入海量数据" tabindex="-1">3. 插入海量数据 <a class="header-anchor" href="#_3-插入海量数据" aria-label="Permalink to &quot;3. 插入海量数据&quot;">​</a></h3><p><code>delimiter ;</code>分割符改回原来</p><p>员工表插入80w条数据 <code>call insert_emp(1000,800000);</code> 部门表插入30条数据 <code>call insert_dept(10,30);</code></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>mysql&gt; select count(1) from emp;</span></span>
<span class="line"><span>+----------+</span></span>
<span class="line"><span>| count(1) |</span></span>
<span class="line"><span>+----------+</span></span>
<span class="line"><span>|   800000 |</span></span>
<span class="line"><span>+----------+</span></span>
<span class="line"><span>1 row in set (0.05 sec)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mysql&gt; select count(1) from dept;</span></span>
<span class="line"><span>+----------+</span></span>
<span class="line"><span>| count(1) |</span></span>
<span class="line"><span>+----------+</span></span>
<span class="line"><span>|       30 |</span></span>
<span class="line"><span>+----------+</span></span>
<span class="line"><span>1 row in set (0.00 sec)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="三、利用profiles分析海量数据" tabindex="-1">三、利用profiles分析海量数据 <a class="header-anchor" href="#三、利用profiles分析海量数据" aria-label="Permalink to &quot;三、利用profiles分析海量数据&quot;">​</a></h2><h3 id="_1-打开profiles" tabindex="-1">1. 打开profiles <a class="header-anchor" href="#_1-打开profiles" aria-label="Permalink to &quot;1. 打开profiles&quot;">​</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>set profiling = on;</span></span>
<span class="line"><span>show variables like &#39;%profiling%&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mysql&gt; set profiling = on;</span></span>
<span class="line"><span>Query OK, 0 rows affected, 1 warning (0.00 sec)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mysql&gt; show variables like &#39;%profiling%&#39;;</span></span>
<span class="line"><span>+------------------------+-------+</span></span>
<span class="line"><span>| Variable_name          | Value |</span></span>
<span class="line"><span>+------------------------+-------+</span></span>
<span class="line"><span>| have_profiling         | YES   |</span></span>
<span class="line"><span>| profiling              | ON    |</span></span>
<span class="line"><span>| profiling_history_size | 15    |</span></span>
<span class="line"><span>+------------------------+-------+</span></span>
<span class="line"><span>3 rows in set (0.00 sec)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><img src="https://img.springlearn.cn/blog/learn_1596455359000.png" alt=""></p><h3 id="_2-查询每条耗时" tabindex="-1">2. 查询每条耗时 <a class="header-anchor" href="#_2-查询每条耗时" aria-label="Permalink to &quot;2. 查询每条耗时&quot;">​</a></h3><p>profiles会记录每个sql的耗时</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>mysql&gt; show profiles;</span></span>
<span class="line"><span>+----------+------------+-----------------------------------+</span></span>
<span class="line"><span>| Query_ID | Duration   | Query                             |</span></span>
<span class="line"><span>+----------+------------+-----------------------------------+</span></span>
<span class="line"><span>|        1 | 0.00164000 | show variables like &#39;%profiling%&#39; |</span></span>
<span class="line"><span>|        2 | 0.04513900 | select count(1) from emp          |</span></span>
<span class="line"><span>|        3 | 0.00056200 | select count(1) from dept         |</span></span>
<span class="line"><span>+----------+------------+-----------------------------------+</span></span>
<span class="line"><span>3 rows in set, 1 warning (0.00 sec)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>但是这样不能精确匹配到耗时在哪里。此时可以使用profile精确来分析sql</p><h3 id="_3-精确查询耗时" tabindex="-1">3. 精确查询耗时 <a class="header-anchor" href="#_3-精确查询耗时" aria-label="Permalink to &quot;3. 精确查询耗时&quot;">​</a></h3><p><strong>精确</strong> 根据上面的Query_ID来精确查找 <code>show profile all for query 2;</code></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>+--------------------------------+----------+----------+------------+-------------------+---------------------+--------------+---------------+---------------+-------------------+-------------------+-------------------+-------+-------------------------+----------------------+-------------+</span></span>
<span class="line"><span>| Status                         | Duration | CPU_user | CPU_system | Context_voluntary | Context_involuntary | Block_ops_in | Block_ops_out | Messages_sent | Messages_received | Page_faults_major | Page_faults_minor | Swaps | Source_function         | Source_file          | Source_line |</span></span>
<span class="line"><span>+--------------------------------+----------+----------+------------+-------------------+---------------------+--------------+---------------+---------------+-------------------+-------------------+-------------------+-------+-------------------------+----------------------+-------------+</span></span>
<span class="line"><span>| starting                       | 0.000106 | 0.000094 |   0.000012 |                 0 |                   0 |            0 |             0 |             0 |                 0 |                 0 |                 0 |     0 | NULL                    | NULL                 |        NULL |</span></span>
<span class="line"><span>| Executing hook on transaction  | 0.000008 | 0.000004 |   0.000004 |                 0 |                   0 |            0 |             0 |             0 |                 0 |                 0 |                 0 |     0 | launch_hook_trans_begin | rpl_handler.cc       |        1106 |</span></span>
<span class="line"><span>| starting                       | 0.000013 | 0.000010 |   0.000002 |                 0 |                   0 |            0 |             0 |             0 |                 0 |                 0 |                 0 |     0 | launch_hook_trans_begin | rpl_handler.cc       |        1108 |</span></span>
<span class="line"><span>| checking permissions           | 0.000009 | 0.000007 |   0.000003 |                 0 |                   0 |            0 |             0 |             0 |                 0 |                 0 |                 0 |     0 | check_access            | sql_authorization.cc |        2202 |</span></span>
<span class="line"><span>| Opening tables                 | 0.000047 | 0.000045 |   0.000002 |                 0 |                   0 |            0 |             0 |             0 |                 0 |                 0 |                 0 |     0 | open_tables             | sql_base.cc          |        5587 |</span></span>
<span class="line"><span>| init                           | 0.000012 | 0.000008 |   0.000003 |                 0 |                   0 |            0 |             0 |             0 |                 0 |                 0 |                 0 |     0 | execute                 | sql_select.cc        |         661 |</span></span>
<span class="line"><span>| System lock                    | 0.000014 | 0.000012 |   0.000003 |                 0 |                   0 |            0 |             0 |             0 |                 0 |                 0 |                 0 |     0 | mysql_lock_tables       | lock.cc              |         332 |</span></span>
<span class="line"><span>| optimizing                     | 0.000010 | 0.000007 |   0.000002 |                 0 |                   0 |            0 |             0 |             0 |                 0 |                 0 |                 0 |     0 | optimize                | sql_optimizer.cc     |         213 |</span></span>
<span class="line"><span>| statistics                     | 0.000037 | 0.000023 |   0.000014 |                 0 |                   0 |            0 |             0 |             0 |                 0 |                 0 |                 1 |     0 | optimize                | sql_optimizer.cc     |         423 |</span></span>
<span class="line"><span>| preparing                      | 0.000025 | 0.000023 |   0.000003 |                 0 |                   0 |            0 |             0 |             0 |                 0 |                 0 |                 0 |     0 | optimize                | sql_optimizer.cc     |         497 |</span></span>
<span class="line"><span>| executing                      | 0.000007 | 0.000004 |   0.000003 |                 0 |                   0 |            0 |             0 |             0 |                 0 |                 0 |                 0 |     0 | exec                    | sql_executor.cc      |         228 |</span></span>
<span class="line"><span>| Sending data                   | 0.044768 | 0.072019 |   0.003191 |                 0 |                 810 |            0 |             0 |             0 |                 0 |                 0 |                 9 |     0 | exec                    | sql_executor.cc      |         304 |</span></span>
<span class="line"><span>| end                            | 0.000018 | 0.000009 |   0.000010 |                 0 |                   0 |            0 |             0 |             0 |                 0 |                 0 |                 0 |     0 | execute                 | sql_select.cc        |         714 |</span></span>
<span class="line"><span>| query end                      | 0.000006 | 0.000004 |   0.000002 |                 0 |                   0 |            0 |             0 |             0 |                 0 |                 0 |                 0 |     0 | mysql_execute_command   | sql_parse.cc         |        4520 |</span></span>
<span class="line"><span>| waiting for handler commit     | 0.000013 | 0.000011 |   0.000001 |                 0 |                   0 |            0 |             0 |             0 |                 0 |                 0 |                 0 |     0 | ha_commit_trans         | handler.cc           |        1533 |</span></span>
<span class="line"><span>| closing tables                 | 0.000009 | 0.000008 |   0.000002 |                 0 |                   0 |            0 |             0 |             0 |                 0 |                 0 |                 0 |     0 | mysql_execute_command   | sql_parse.cc         |        4566 |</span></span>
<span class="line"><span>| freeing items                  | 0.000026 | 0.000012 |   0.000013 |                 0 |                   0 |            0 |             0 |             1 |                 0 |                 0 |                 0 |     0 | mysql_parse             | sql_parse.cc         |        5237 |</span></span>
<span class="line"><span>| cleaning up                    | 0.000011 | 0.000009 |   0.000002 |                 0 |                   0 |            0 |             0 |             0 |                 0 |                 0 |                 0 |     0 | dispatch_command        | sql_parse.cc         |        2147 |</span></span>
<span class="line"><span>+--------------------------------+----------+----------+------------+-------------------+---------------------+--------------+---------------+---------------+-------------------+-------------------+-------------------+-------+-------------------------+----------------------+-------------+</span></span>
<span class="line"><span>18 rows in set, 1 warning (0.00 sec)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>我们可以看到信息太多了,我们其实只用关系几列的数据就行了。</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>mysql&gt; show profile cpu,block io for query 2;</span></span>
<span class="line"><span>+--------------------------------+----------+----------+------------+--------------+---------------+</span></span>
<span class="line"><span>| Status                         | Duration | CPU_user | CPU_system | Block_ops_in | Block_ops_out |</span></span>
<span class="line"><span>+--------------------------------+----------+----------+------------+--------------+---------------+</span></span>
<span class="line"><span>| starting                       | 0.000106 | 0.000094 |   0.000012 |            0 |             0 |</span></span>
<span class="line"><span>| Executing hook on transaction  | 0.000008 | 0.000004 |   0.000004 |            0 |             0 |</span></span>
<span class="line"><span>| starting                       | 0.000013 | 0.000010 |   0.000002 |            0 |             0 |</span></span>
<span class="line"><span>| checking permissions           | 0.000009 | 0.000007 |   0.000003 |            0 |             0 |</span></span>
<span class="line"><span>| Opening tables                 | 0.000047 | 0.000045 |   0.000002 |            0 |             0 |</span></span>
<span class="line"><span>| init                           | 0.000012 | 0.000008 |   0.000003 |            0 |             0 |</span></span>
<span class="line"><span>| System lock                    | 0.000014 | 0.000012 |   0.000003 |            0 |             0 |</span></span>
<span class="line"><span>| optimizing                     | 0.000010 | 0.000007 |   0.000002 |            0 |             0 |</span></span>
<span class="line"><span>| statistics                     | 0.000037 | 0.000023 |   0.000014 |            0 |             0 |</span></span>
<span class="line"><span>| preparing                      | 0.000025 | 0.000023 |   0.000003 |            0 |             0 |</span></span>
<span class="line"><span>| executing                      | 0.000007 | 0.000004 |   0.000003 |            0 |             0 |</span></span>
<span class="line"><span>| Sending data                   | 0.044768 | 0.072019 |   0.003191 |            0 |             0 |</span></span>
<span class="line"><span>| end                            | 0.000018 | 0.000009 |   0.000010 |            0 |             0 |</span></span>
<span class="line"><span>| query end                      | 0.000006 | 0.000004 |   0.000002 |            0 |             0 |</span></span>
<span class="line"><span>| waiting for handler commit     | 0.000013 | 0.000011 |   0.000001 |            0 |             0 |</span></span>
<span class="line"><span>| closing tables                 | 0.000009 | 0.000008 |   0.000002 |            0 |             0 |</span></span>
<span class="line"><span>| freeing items                  | 0.000026 | 0.000012 |   0.000013 |            0 |             0 |</span></span>
<span class="line"><span>| cleaning up                    | 0.000011 | 0.000009 |   0.000002 |            0 |             0 |</span></span>
<span class="line"><span>+--------------------------------+----------+----------+------------+--------------+---------------+</span></span>
<span class="line"><span>18 rows in set, 1 warning (0.01 sec)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mysql&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="_4-全局查询日志" tabindex="-1">4. 全局查询日志 <a class="header-anchor" href="#_4-全局查询日志" aria-label="Permalink to &quot;4. 全局查询日志&quot;">​</a></h3><p>仅仅在调优和开发中使用,生产要关闭</p><p><code>show variables like &#39;%general_log%&#39;;</code></p><p>开启全局日志记录并将sql都写入到表中</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>set global general_log = 1;</span></span>
<span class="line"><span>set global log_output = &#39;table&#39;;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>mysql&gt; show variables like &#39;%general_log%&#39;;</span></span>
<span class="line"><span>+------------------+------------------------------------+</span></span>
<span class="line"><span>| Variable_name    | Value                              |</span></span>
<span class="line"><span>+------------------+------------------------------------+</span></span>
<span class="line"><span>| general_log      | OFF                                |</span></span>
<span class="line"><span>| general_log_file | /usr/local/var/mysql/localhost.log |</span></span>
<span class="line"><span>+------------------+------------------------------------+</span></span>
<span class="line"><span>2 rows in set (0.01 sec)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mysql&gt; set global general_log = 1;</span></span>
<span class="line"><span>Query OK, 0 rows affected (0.00 sec)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mysql&gt; show variables like &#39;%general_log%&#39;;</span></span>
<span class="line"><span>+------------------+------------------------------------+</span></span>
<span class="line"><span>| Variable_name    | Value                              |</span></span>
<span class="line"><span>+------------------+------------------------------------+</span></span>
<span class="line"><span>| general_log      | ON                                 |</span></span>
<span class="line"><span>| general_log_file | /usr/local/var/mysql/localhost.log |</span></span>
<span class="line"><span>+------------------+------------------------------------+</span></span>
<span class="line"><span>2 rows in set (0.01 sec)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>开启之后就可以在mysql库中的general_log表中进行查询</p><p><code>select * from mysql.general_log;</code><img src="https://img.springlearn.cn/blog/learn_1596457337000.png" alt=""></p><p>将sql设置到文件中</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>set global general_log = 1;</span></span>
<span class="line"><span>set global log_output = &#39;file&#39;;</span></span>
<span class="line"><span>set global general_log_file=&#39;/Users/liuxin/general.log&#39;;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="https://img.springlearn.cn/blog/learn_1596457737000.png" alt=""></p><p>最后求关注,求订阅,谢谢你的阅读!</p>`,50)]))}const d=n(l,[["render",i]]);export{u as __pageData,d as default};
