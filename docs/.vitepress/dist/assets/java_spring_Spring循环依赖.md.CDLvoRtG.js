import{_ as s,c as i,o as a,ac as n}from"./chunks/framework.C9DUt1S1.js";const c=JSON.parse('{"title":"Springå¾ªç¯ä¾èµ–","description":"","frontmatter":{"breadcrumb":false,"navbar":true,"sidebar":true,"pageInfo":true,"contributor":true,"editLink":true,"updateTime":true,"prev":true,"next":true,"comment":true,"footer":true,"backtotop":true,"title":"Springå¾ªç¯ä¾èµ–","category":"Spring"},"headers":[],"relativePath":"java/spring/Springå¾ªç¯ä¾èµ–.md","filePath":"java/spring/Springå¾ªç¯ä¾èµ–.md"}'),t={name:"java/spring/Springå¾ªç¯ä¾èµ–.md"},l=n(`<p><img src="https://img.springlearn.cn/blog/learn_1647108921000.png" alt=""></p><p><strong>ä½œè€…: å…«é˜¿å“¥çš„å‰‘</strong></p><p><em>åšå®¢: <a href="https://springlearn.cn" target="_blank" rel="noreferrer">https://springlearn.cn</a></em></p><div class="tip custom-block"><p class="custom-block-title">ä¸€æ—¥ä¸€å¥æ¯’é¸¡æ±¤</p><p>é—®ä¸–é—´é’±ä¸ºä½•ç‰©ï¼Œåªå«äººç”Ÿæ­»ç›¸è®¸ã€‚ï¼ğŸ˜„</p></div><p>å†™æ–‡ç« ä¸å®¹æ˜“ï¼Œå¦‚æœæ„Ÿè§‰è¿˜è¡Œï¼Œè¯·ç‚¹ä¸ªå…³æ³¨ï¼Œç‚¹å…³æ³¨ä¸è¿·è·¯ã€‚</p><h2 id="ä¸€ã€ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–" tabindex="-1">ä¸€ã€ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ– <a class="header-anchor" href="#ä¸€ã€ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–" aria-label="Permalink to &quot;ä¸€ã€ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–&quot;">â€‹</a></h2><p>è¿™ç§ç®€å•çš„é—®é¢˜ï¼Œç›´æ¥ä¼ªä»£ç å§ã€‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Service</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> A</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> B b;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Service</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> B</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> A a;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>æˆ‘ä¸­æœ‰ä½ ï¼Œä½ ä¸­æœ‰æˆ‘ã€‚</p><h2 id="äºŒã€è§£å†³å¾ªç¯ä¾èµ–æ€è·¯" tabindex="-1">äºŒã€è§£å†³å¾ªç¯ä¾èµ–æ€è·¯ <a class="header-anchor" href="#äºŒã€è§£å†³å¾ªç¯ä¾èµ–æ€è·¯" aria-label="Permalink to &quot;äºŒã€è§£å†³å¾ªç¯ä¾èµ–æ€è·¯&quot;">â€‹</a></h2><p>æ€è·¯å…¶å®éå¸¸ç®€å•è¿˜æ˜¯ç”¨ä¼ªä»£ç æ¥è¯´æ˜</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> A</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> B</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">a.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(b);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">b.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a);</span></span></code></pre></div><p>æ€è·¯å°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œå…ˆåˆ†åˆ«æŠŠAå’ŒBç»™å®ä¾‹åŒ–ã€‚ è¿™æ—¶å€™å®ä¾‹åŒ–çš„Aå’ŒBä»…ä»…æ˜¯å®Œæˆäº†å®ä¾‹åŒ–,å†…éƒ¨çš„å±æ€§å…¶å®éƒ½æ²¡æœ‰ã€‚ åªæœ‰å½“æ‰§è¡Œäº†3ã€4è¡Œæ‰ç®—æ­£å¸¸å®Œæˆã€‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> A</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> B</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">a.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(b);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">b.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a);</span></span></code></pre></div><p>é€šè¿‡ä¸Šé¢çš„ä»£ç æˆ‘ä»¬æ€»ç»“ä¸‹ï¼Œè¦æƒ³å®ç°å¾ªç¯æ³¨å…¥ã€‚é¦–å…ˆè¦æ»¡è¶³ç¬¬ä¸€ä¸ªæ¡ä»¶ã€‚</p><ol><li><strong>èƒ½è¢«å®ä¾‹åŒ–</strong></li></ol><ul><li>æœ‰ç©ºæ„é€ </li><li>æˆ–æœ‰æ„é€ ä¸”æ„é€ å‚æ•°æ»¡è¶³èƒ½è¢«å®ä¾‹åŒ–ã€‚</li></ul><p>å¥½äº†ï¼ŒçŸ¥é“è¿™ç‚¹å°±æˆäº†ï¼Œç›¸ä¿¡è®©ä½ æ¥å®ç°å¾ªç¯æ³¨å…¥ï¼Œåº”è¯¥ä¹Ÿå¯ä»¥äº†å§ã€‚å…¶å®å°±è¿™ä¹ˆç®€å• ?</p><p>é‚£æˆ‘ä»¬æ¥çœ‹Springå¦‚ä½•æ¥å®ç°çš„ã€‚ç›¸ä¿¡çœ‹å®Œä½ å°±å¤´å¤§äº†ã€‚ä½†æ˜¯æ²¡å…³ç³»ï¼ŒåŸºæœ¬åŸç†ä½ å·²ç»çŸ¥é“äº†ã€‚ å¸¦ç€è¿™ä¸ªæ€è·¯æ¥çœ‹Springçš„æºç å°±ç®€å•äº†ã€‚</p><h2 id="ä¸‰ã€springå¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–" tabindex="-1">ä¸‰ã€Springå¦‚ä½•è§£å†³å¾ªç¯ä¾èµ– <a class="header-anchor" href="#ä¸‰ã€springå¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–" aria-label="Permalink to &quot;ä¸‰ã€Springå¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–&quot;">â€‹</a></h2><p>é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“Springä¸­çš„bean, æœ‰ä¸¤ç§å½¢å¼ã€‚</p><ul><li>ç¬¬ä¸€ç§æ˜¯å•ä¾‹ã€‚æ‰€è°“å•ä¾‹å°±æ˜¯å®¹å™¨ä¸­è¿™ä¸ªç±»ï¼Œåªä¼šå­˜åœ¨ä¸€ä¸ªå®ä¾‹ã€‚ä¸ç®¡ä½ è°ƒç”¨äº†å¤šå°‘æ¬¡ <code>getBean(String beanName)</code> è¿”å›çš„éƒ½æ˜¯ä¸€ä¸ªå®ä¾‹(å› ä¸ºæ¯æ¬¡éƒ½ä»ç¼“å­˜ä¸­è·å–çš„å®ä¾‹)ã€‚</li><li>ç¬¬äºŒç§æ˜¯åŸå‹ã€‚æ‰€è°“åŸå‹å°±æ˜¯å®¹å™¨ä¸­è¿™ä¸ªç±»ï¼Œæ²¡æœ‰ç¼“å­˜ã€‚æ¯æ¬¡éƒ½æ˜¯æ–°å»ºä¸€ä¸ªBeanã€‚</li></ul><p>åœ¨è¿™é‡Œæˆ‘ä»¬æ€è€ƒä¸‹ï¼Œå¦‚æœè¦ä½ æ¥å®ç°å¾ªç¯æ³¨å…¥ï¼Œä»¥ä¸Šä¸¤ç§æ¨¡å¼ã€‚ä½ èƒ½ç”¨é‚£ä¸€ä¸ª? è¦æƒ³å®ç°å¾ªç¯æ³¨å…¥ï¼Œå³è¿™ä¸ªBeanå¿…é¡»è¦æœ‰ä¸€ä¸ªç¼“å­˜çš„åœ°æ–¹ã€‚ä¸ç„¶æ¯æ¬¡éƒ½æ˜¯åˆ›å»ºï¼Œè™½ç„¶èƒ½å®Œæˆå®ä¾‹åŒ–ï¼Œä½†æ˜¯å®ä¾‹åŒ–åï¼Œéœ€è¦æ³¨å…¥çš„ <code>bean</code> æ— æ³•å®ç°æ³¨å…¥ï¼Œå°±ä¼šé™·å…¥æ­»å¾ªç¯ã€‚</p><p>è¿™é‡Œç¬¬äºŒä¸ªå¿…è¦å› ç´ å°±å‡ºæ¥äº†ã€‚</p><p>==2. å¿…é¡»è¦æ˜¯å•ä¾‹==</p><p>å¥½äº†ï¼ŒçŸ¥é“è¿™ä¹ˆå¤šæˆ‘ä»¬å¼€å§‹çœ‹æºç å§ã€‚</p><h3 id="_3-1-springä¸­åˆ›å»ºbeançš„æ­¥éª¤" tabindex="-1">3.1 Springä¸­åˆ›å»ºBeançš„æ­¥éª¤ <a class="header-anchor" href="#_3-1-springä¸­åˆ›å»ºbeançš„æ­¥éª¤" aria-label="Permalink to &quot;3.1 Springä¸­åˆ›å»ºBeançš„æ­¥éª¤&quot;">â€‹</a></h3><ul><li>å®ä¾‹åŒ–ï¼ŒcreateBeanInstanceï¼Œå°±æ˜¯newäº†ä¸ªå¯¹è±¡ã€‚</li><li>å±æ€§æ³¨å…¥ï¼ŒpopulateBeanï¼Œ å°±æ˜¯ set ä¸€äº›å±æ€§å€¼ã€‚</li><li>åˆå§‹åŒ–ï¼ŒinitializeBeanï¼Œæ‰§è¡Œä¸€äº› aware æ¥å£ä¸­çš„æ–¹æ³•ï¼ŒinitMethodï¼ŒAOPä»£ç†ç­‰</li></ul><h3 id="_3-2-å¾ªç¯ä¾èµ–ä¸‰å±‚ç¼“å­˜" tabindex="-1">3.2 å¾ªç¯ä¾èµ–ä¸‰å±‚ç¼“å­˜ <a class="header-anchor" href="#_3-2-å¾ªç¯ä¾èµ–ä¸‰å±‚ç¼“å­˜" aria-label="Permalink to &quot;3.2 å¾ªç¯ä¾èµ–ä¸‰å±‚ç¼“å­˜&quot;">â€‹</a></h3><p>æ³¨æ„çœ‹ç»†èŠ‚ï¼Œæ¯ä¸ªç¼“å­˜çš„æ•°æ®ç±»å‹æ˜¯ä»€ä¹ˆ? åé¢è¦è€ƒã€‚</p><p><img src="https://img.springlearn.cn/blog/learn_1647104251000.png" alt=""></p><ul><li>ä¸€çº§ç¼“å­˜ <code>Map&lt;String, Object&gt; singletonObjects </code><ul><li>å¦‚æœç­‰äºç©ºï¼Œæˆ–è€…å½“å‰å•ä¾‹æ­£åœ¨åˆ›å»ºä¸­(å³åªå®Œæˆäº†å®ä¾‹åŒ–)ã€‚å°±ä»äºŒçº§ç¼“å­˜ä¸­è·å–ã€‚</li></ul></li><li>äºŒçº§ç¼“å­˜ <code>Map&lt;String, Object&gt; earlySingletonObjects</code><ul><li>å¦‚æœç­‰äºç©ºï¼Œå°±ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–ã€‚</li></ul></li><li>ä¸‰çº§ç¼“å­˜ <code>Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories</code><ul><li>åˆ›å»ºBeançš„ä¸€ä¸ªå·¥å‚ï¼Œå…è®¸å®¹å™¨ä¸­å®šä¹‰ç‰¹æ®Šçš„ï¼Œç”ŸæˆBeançš„æ–¹æ³•ã€‚ä½¿ç”¨ <code>addSingletonFactory</code></li></ul></li></ul><p>å…¶å®è¦æƒ³å®ç°å¾ªç¯ä¾èµ–åªç”¨2ä¸ªç¼“å­˜å°±è¡Œã€‚ä¸‰çº§ç¼“å­˜çš„æ„ä¹‰æ˜¯ä¸ºäº†å®ŒæˆæŸäº›åŠŸèƒ½ã€‚è‡³äºä»€ä¹ˆåŠŸèƒ½å‘¢? è¿™é‡Œå…ˆä¸è¯´åé¢çœ‹æµç¨‹ã€‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String beanName, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> allowEarlyReference) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		Object singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.singletonObjects.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName);</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isSingletonCurrentlyInCreation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			synchronized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.singletonObjects) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.earlySingletonObjects.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> allowEarlyReference) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					ObjectFactory&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; singletonFactory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.singletonFactories.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">					if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (singletonFactory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">						singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> singletonFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">						this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.earlySingletonObjects.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName, singletonObject);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">						this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.singletonFactories.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> singletonObject;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>å¥½æˆ‘ä»¬çŸ¥é“æœ‰è¿™ä¸¤ä¸ªç¼“å­˜å°±ç»§ç»­å¾€ä¸‹çœ‹æºç ã€‚å½“ <code>getSingleton</code> æ˜¯ <code>null</code>ã€‚ç»§ç»­å¾€ä¸‹èµ°ã€‚å…¶ä»–æºç å°±è·³è¿‡äº†ï¼Œä¸æ˜¯æœ¬ç¯‡çš„ä¸»è¦å†…å®¹ï¼Œæˆ‘ä»¬åªçœ‹ è§£å†³å¾ªç¯ä¾èµ–çš„æ ¸å¿ƒä»£ç ã€‚</p><ul><li>doCreateBean#createBeanInstance å…ˆå®ç°å®ä¾‹åŒ–ã€‚</li><li>å½“å‰beanæ˜¯å•ä¾‹,ä¸ä¼šæ·»åŠ åˆ°äºŒçº§ç¼“å­˜ï¼Œç›´æ¥å°±æ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜ä¸­,æ³¨æ„è¿™é‡Œä¸æ˜¯æ·»åŠ çš„Beanï¼Œè€Œæ˜¯ç”ŸæˆBeançš„å·¥å‚æ–¹æ³• <code>ObjectFactory(#getEarlyBeanReference)</code>ã€‚</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	   boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> earlySingletonExposure </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.allowCircularReferences </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">				isSingletonCurrentlyInCreation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (earlySingletonExposure) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isTraceEnabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">trace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Eagerly caching bean &#39;&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> beanName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">						&quot;&#39; to allow for resolving potential circular references&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">			addSingletonFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getEarlyBeanReference</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName, mbd, bean));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span></code></pre></div><ul><li>doCreateBean#populateBean å®ç°å±æ€§æ³¨å…¥</li></ul><p>ä»¥ä¸Šé¢çš„ä»£ç çš„ä¾‹å­ï¼ŒAåˆ›å»ºæ—¶å€™è¢«åŠ å…¥åˆ°äº†ä¸‰çº§ç¼“å­˜ä¸­ï¼Œç„¶åç»§ç»­æ‰§è¡Œ <code>populateBean</code>ã€‚å‘ç°è¦ä¾èµ–Bã€‚ç„¶åä¾æ¬¡ä»ç¼“å­˜ä¸­ æ¥æ‰¾è¿™ä¸ªAã€‚æœ€ç»ˆåœ¨ä¸‰çº§ç¼“å­˜ä¸­è¯»å–åˆ°äº†Bã€‚ç„¶åå®ç°æ³¨å…¥ã€‚è¿™é‡Œä¸‰çº§ç¼“å­˜ä¸­çš„ <code>Bean</code>ã€‚ æœ‰å¯èƒ½åªæ˜¯å®Œæˆäº† <code>new</code>ã€‚ä½†æ˜¯å®¹å™¨ ä¸ç®¡ï¼Œå…ˆå®Œæˆå¾ªç¯æ³¨å…¥ã€‚è‡³äºæ³¨å…¥çš„ä¸œè¥¿æ˜¯å¦æ˜¯å®Œå…¨å“è¿˜æ˜¯åŠæˆå“ä¸å…³å¿ƒï¼Œå› ä¸ºéƒ½æ˜¯å•ä¾‹æ‰€ä»¥ï¼Œåé¢åœ¨æ³¨å…¥å±æ€§ä¹Ÿæ²¡å…³ç³»ã€‚ è¿™é‡Œæˆ‘ä»¬çŸ¥é“å•ä¾‹çš„ç”¨å¤„äº†å§ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä¸æ˜¯å•ä¾‹æ¨¡å¼ï¼Œè€Œæ˜¯åŸå‹æ¨¡å¼ã€‚é‚£ä¹ˆbeanå°±å¿…é¡»æ˜¯å®Œå…¨å“ï¼Œä¸ç„¶å°±é™·å…¥äº†æ­»å¾ªç¯ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬è¿˜ç”¨ä¼ªä»£ç çš„æ–¹å¼å†æ¥è¯´ä¸€ç¯‡å®ç°æ€è·¯ã€‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// createBeanInstanceå…ˆå®ä¾‹åŒ–ï¼Œç„¶ååŠ å…¥åˆ°ä¸‰çº§ç¼“å­˜ä¸­</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> A</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// aåœ¨æ‰§è¡ŒpopulateBeançš„æ—¶å€™ï¼Œå‘ç°è¦æ³¨å…¥å±æ€§Bï¼Œäºæ˜¯å°±ä½¿ç”¨getBeanã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// getBean(b) æ‰§è¡ŒcreateBeanInstanceå…ˆå®ä¾‹åŒ–</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> B</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç„¶ååŠ å…¥åˆ°ä¸‰çº§ç¼“å­˜ä¸­ï¼Œbåœ¨æ‰§è¡ŒpopulateBeanæ³¨å…¥å±æ€§å€¼çš„æ—¶å€™ã€‚å‘ç°ä¹Ÿä¾èµ–äº†Aã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç„¶åä»ç¼“å­˜ä¸­æ‰¾åˆ°åŠæˆå“Aã€‚äºæ˜¯ä¹Bçš„æ³¨å…¥å°±å®Œæˆï¼Œç„¶åå†æ‰§è¡ŒBçš„initæ–¹æ³•ã€‚</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">b.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Bå®Œæˆå,åˆ™è¿”å›åˆ°Açš„populateBeanä¹Ÿæ³¨å…¥äº†Bã€‚ç„¶ååœ¨æ‰§è¡ŒAçš„initæ–¹æ³•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">a.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(b);</span></span></code></pre></div><p>åˆ°è¿™é‡Œå°±å®Œæˆäº†å¾ªç¯æ³¨å…¥ï¼Œè¿™é‡Œæœ‰ç‚¹ç»•ï¼Œå°ç¼–ç”»äº†ä¸€ä¸ªå›¾ï¼Œå¤§å®¶è·Ÿç€åºå·æ¥çœ‹ï¼Œç„¶åå¥½å¥½ç†è§£ä¸‹ã€‚</p><p><img src="https://img.springlearn.cn/blog/learn_1647104949000.png" alt=""></p><p>é€šè¿‡è¿™ä¸ªå›¾å…¶å®æˆ‘ä»¬èƒ½å‘ç°ä¸€ä¸ªé—®é¢˜ã€‚Bæ­¤æ—¶ä»ä¸‰çº§ç¼“å­˜ä¸­æ‹¿åˆ°çš„Aæ˜¯ä¸€ä¸ªåŠæˆå“çš„Aã€‚ å‡å¦‚Båœ¨æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•çš„æ—¶å€™,ä¾èµ–Açš„populateBeanæ³¨å…¥çš„å±æ€§ã€‚é‚£ä¹ˆæ­¤æ—¶ä¸€å®šä¼šæ‹¿ä¸åˆ°çš„ã€‚ ä¸‹é¢å†™ç‚¹ä¼ªä»£ç ï¼Œè¯´ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚</p><h3 id="_3-3-å‘ç°ç‚¹é—®é¢˜" tabindex="-1">3.3 å‘ç°ç‚¹é—®é¢˜ <a class="header-anchor" href="#_3-3-å‘ç°ç‚¹é—®é¢˜" aria-label="Permalink to &quot;3.3 å‘ç°ç‚¹é—®é¢˜&quot;">â€‹</a></h3><h4 id="_3-3-1-åŠæˆå“é—®é¢˜-1" tabindex="-1">3.3.1 åŠæˆå“é—®é¢˜-1 <a class="header-anchor" href="#_3-3-1-åŠæˆå“é—®é¢˜-1" aria-label="Permalink to &quot;3.3.1 åŠæˆå“é—®é¢˜-1&quot;">â€‹</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> A</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InitializingBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> B b;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;\${a.name}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String name;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> afterPropertiesSet</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Exception {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;A:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> B</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InitializingBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> A a;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> afterPropertiesSet</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Exception {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;B:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><img src="https://img.springlearn.cn/blog/learn_1647105136000.png" alt=""></p><p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬çŸ¥é“Bä¼šå…ˆæ‰§è¡Œåˆå§‹åŒ–ï¼Œè€Œè¿™é‡ŒBçš„åˆå§‹åŒ– ==(å›¾ä¾‹8)== ä¼šä¾èµ–Açš„å‚æ•°æ³¨å…¥ ==(å›¾ä¾‹4)== ã€‚è€ŒBåœ¨æ‰§è¡Œåˆå§‹åŒ–çš„æ—¶å€™ã€‚A(å›¾ä¾‹4æ²¡æœ‰å®Œå…¨å®Œæˆæ³¨å…¥)å¹¶æ²¡æœ‰å®Œæˆå±æ€§æ³¨å…¥ã€‚ é‚£ä¹ˆæˆ‘ä»¬æ­¤æ—¶åœ¨æ‹¿åˆ°Açš„getNameä¸€å®šæ˜¯ç©ºçš„ã€‚</p><p><strong>ä»¥ä¸Šä»£ç æ‰§è¡Œå°±æ˜¯:</strong></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">com.example.demo.B@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">38aa816f</span></span></code></pre></div><h4 id="_3-3-2-åŠæˆå“é—®é¢˜-2" tabindex="-1">3.3.2 åŠæˆå“é—®é¢˜-2 <a class="header-anchor" href="#_3-3-2-åŠæˆå“é—®é¢˜-2" aria-label="Permalink to &quot;3.3.2 åŠæˆå“é—®é¢˜-2&quot;">â€‹</a></h4><p>Açš„BeanPostProcessoræ²¡æœ‰æ‰§è¡Œ,é‚£ä¹ˆå‡å¦‚æˆ‘ä»¬æƒ³è¦å¯¹Aè¿›è¡Œæ–¹æ³•ä»£ç†ã€‚Båœ¨æ‰§è¡Œåˆå§‹åŒ–çš„æ—¶å€™,è°ƒç”¨Açš„ <code>getName</code>ã€‚ä¼šæˆåŠŸä»£ç†ä¸Šå—?</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> A</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InitializingBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> B b;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;å­™æ‚Ÿç©º&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> afterPropertiesSet</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Exception {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;A:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> B</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InitializingBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> A a;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> afterPropertiesSet</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Exception {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;B:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Aspect</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AopConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * ç²¾ç¡®åŒ¹é…ç±»å</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Pointcut</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;within(A)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> matchClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Before</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;matchClass()&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> beforeMatchClassName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--------ç²¾ç¡®åŒ¹é…ç±»å-------&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>æ‰§è¡Œç»“æœ:</strong></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">--------</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ç²¾ç¡®åŒ¹é…ç±»å</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-------</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">å­™æ‚Ÿç©º</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">com.example.demo.B@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">5e01a982</span></span></code></pre></div><p>å‘ç°ç–‘é—®äº†å—? å‰é¢æˆ‘ä»¬è¯´äº†,åœ¨æ‰§è¡ŒBå›¾ä¾‹8çš„æ—¶å€™(bçš„åˆå§‹åŒ–æ–¹æ³•)ï¼ŒAå›¾ä¾‹9å¹¶æ²¡æœ‰æ‰§è¡Œï¼Œé‚£ä¸ºä»€ä¹ˆè¿™é‡Œä¼šä»£ç†æˆåŠŸå‘¢? <img src="https://img.springlearn.cn/blog/learn_1647105949000.png" alt=""></p><div class="info custom-block"><p class="custom-block-title">ç­”æ¡ˆæ­æ™“</p><p>è¿™é‡Œåœ¨æ·»åŠ ç¼“å­˜çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯ç›´æ¥æŠŠå®ä¾‹æ·»åŠ åˆ°ç¼“å­˜ä¸­çš„ã€‚ è€Œæ˜¯å°†å›¾ä¾‹9çš„é€»è¾‘ï¼Œå°è£…åˆ° ObjectFactoryçš„æ–¹å¼æ·»åŠ åˆ°ç¼“å­˜ä¸­çš„ã€‚ ObjectFactory#getObjectæ—¶å€™æ‰§è¡Œäº†Bean çš„å¤„ç†ã€‚(AOPä»£ç†ç­‰)</p></div><p><strong>æ³¨æ„: è¿™é‡Œå¹¶ä¸æ˜¯æŠŠæ‰€æœ‰çš„å¤„ç†å™¨éƒ½åŒ…è£…åˆ°ObjectFactoryæ–¹æ³•ä¸­,è€Œæ˜¯æœ‰é€‰æ‹©çš„ä½¿ç”¨,åªæœ‰å®ç°äº†SmartInstantiationAwareBeanPostProcessoræ¥å£ æ‰ä¼šæ”¾åˆ°é‡Œé¢ã€‚</strong></p><p><img src="https://img.springlearn.cn/blog/learn_1647106252000.png" alt=""></p><p>ç­”æ¡ˆå°±åœ¨è¿™é‡Œï¼Œè¿™é‡Œæ‰§è¡Œäº†ã€‚ä¸€äº›ç‰¹æ®Šé€»è¾‘çš„å¤„ç†å™¨ã€‚å½“å®ç°äº† <code>SmartInstantiationAwareBeanPostProcessor</code> æ¥å£ã€‚ å°±å¯ä»¥æå‰å¯¹é‚£äº›åŠæˆå“çš„Beanè¿›è¡Œå¤„ç†ã€‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getEarlyBeanReference</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String beanName, RootBeanDefinition mbd, Object bean) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		Object exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bean;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mbd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isSynthetic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> hasInstantiationAwareBeanPostProcessors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (SmartInstantiationAwareBeanPostProcessor bp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getBeanPostProcessorCache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().smartInstantiationAware) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				exposedObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bp.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getEarlyBeanReference</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(exposedObject, beanName);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> exposedObject;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>æ¯”å¦‚AOPçš„å®ç°ç±»ã€‚ <img src="https://img.springlearn.cn/blog/learn_1647106893000.png" alt=""></p><p>è¿™é‡Œæˆ‘ä»¬åœ¨æ€è€ƒä¸€ä¸ªé—®é¢˜ã€‚AåŠæˆå“çš„æ—¶å€™è¢«AOPä»£ç†äº†ä¸€æ¬¡ï¼Œé‚£ä¹ˆå½“Aåœ¨æ‰§è¡ŒBeanå¤„ç†å™¨çš„æ—¶å€™å²‚ä¸æ˜¯æœ‰è¦è¢«ä»£ç†ä¸€æ¬¡å—?</p><p>AbstractAutoProxyCreator#getEarlyBeanReference</p><p>ç¬¬ä¸€æ¬¡ä»£ç†æ—¶å€™ä¼šè¢«åŠ åˆ°ç¼“å­˜ä¸­ã€‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getEarlyBeanReference</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Object bean, String beanName) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Object cacheKey </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCacheKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bean.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), beanName);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.earlyProxyReferences.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cacheKey, bean);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wrapIfNecessary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bean, beanName, cacheKey);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span></code></pre></div><p>ç¬¬äºŒæ¬¡æ—¶å€™åœ¨æ‰§è¡ŒAOPåç½®å¤„ç†å™¨,ä¼šå…ˆåˆ¤æ–­ç¼“å­˜,å¦‚æœç¼“å­˜ä¸­å­˜åœ¨å°±ä¸åœ¨å¤„ç†äº†ã€‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">postProcessAfterInitialization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Nullable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object bean, String beanName) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (bean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Object cacheKey </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCacheKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bean.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.earlyProxyReferences.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cacheKey) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bean) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wrapIfNecessary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bean, beanName, cacheKey);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bean;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span></code></pre></div><h2 id="å››ã€çŸ¥è¯†ç‚¹æ€»ç»“" tabindex="-1">å››ã€çŸ¥è¯†ç‚¹æ€»ç»“ <a class="header-anchor" href="#å››ã€çŸ¥è¯†ç‚¹æ€»ç»“" aria-label="Permalink to &quot;å››ã€çŸ¥è¯†ç‚¹æ€»ç»“&quot;">â€‹</a></h2><h3 id="_4-1-æ»¡è¶³å¾ªç¯ä¾èµ–çš„æ¡ä»¶æ˜¯ä»€ä¹ˆ" tabindex="-1">4.1 æ»¡è¶³å¾ªç¯ä¾èµ–çš„æ¡ä»¶æ˜¯ä»€ä¹ˆ? <a class="header-anchor" href="#_4-1-æ»¡è¶³å¾ªç¯ä¾èµ–çš„æ¡ä»¶æ˜¯ä»€ä¹ˆ" aria-label="Permalink to &quot;4.1 æ»¡è¶³å¾ªç¯ä¾èµ–çš„æ¡ä»¶æ˜¯ä»€ä¹ˆ?&quot;">â€‹</a></h3><ol><li>å¿…é¡»æ˜¯å•ä¾‹æ¨¡å¼</li><li>å¾ªç¯ä¾èµ–ç±»,å¿…é¡»èƒ½å®ä¾‹åŒ–(ç©ºæ„é€ ,æˆ–æ„é€ å‚æ•°æ»¡è¶³å¾ªç¯ä¾èµ–æ¡ä»¶)</li></ol><h3 id="_4-2-å¾ªç¯ä¾èµ–å¯èƒ½å¯¼è‡´ä»€ä¹ˆé—®é¢˜" tabindex="-1">4.2 å¾ªç¯ä¾èµ–å¯èƒ½å¯¼è‡´ä»€ä¹ˆé—®é¢˜? <a class="header-anchor" href="#_4-2-å¾ªç¯ä¾èµ–å¯èƒ½å¯¼è‡´ä»€ä¹ˆé—®é¢˜" aria-label="Permalink to &quot;4.2 å¾ªç¯ä¾èµ–å¯èƒ½å¯¼è‡´ä»€ä¹ˆé—®é¢˜?&quot;">â€‹</a></h3><p>åœ¨æ‰§è¡Œåˆå§‹åŒ–çš„æ—¶å€™ï¼Œå¦‚æœåˆå§‹åŒ–æ–¹æ³•ï¼Œä¾èµ–å¾ªç¯æ¥çš„å±æ€§æ³¨å…¥å‚æ•°ï¼Œå¯èƒ½å¯¼è‡´è·å–ä¸åˆ°æ•°æ®ä¿¡æ¯çš„æƒ…å†µ</p><p>å¦‚ä¸Šé¢é—®é¢˜1ã€‚</p><h3 id="_4-3-ä¸ºä»€ä¹ˆè¦ç”¨ä¸‰çº§ç¼“å­˜è€Œä¸æ˜¯äºŒçº§ç¼“å­˜" tabindex="-1">4.3 ä¸ºä»€ä¹ˆè¦ç”¨ä¸‰çº§ç¼“å­˜è€Œä¸æ˜¯äºŒçº§ç¼“å­˜? <a class="header-anchor" href="#_4-3-ä¸ºä»€ä¹ˆè¦ç”¨ä¸‰çº§ç¼“å­˜è€Œä¸æ˜¯äºŒçº§ç¼“å­˜" aria-label="Permalink to &quot;4.3 ä¸ºä»€ä¹ˆè¦ç”¨ä¸‰çº§ç¼“å­˜è€Œä¸æ˜¯äºŒçº§ç¼“å­˜?&quot;">â€‹</a></h3><p>ä¸ºäº†æ»¡è¶³Springå£°æ˜å‘¨æœŸæ–¹æ³•,å³å¯¹åŠæˆå“çš„Bè¿›è¡Œæå‰ç”Ÿå‘½å‘¨æœŸå¤„ç†ã€‚å¦‚å®ç°AOPã€‚</p><h2 id="äº”ã€å¼€æ”¾æ€§é—®é¢˜" tabindex="-1">äº”ã€å¼€æ”¾æ€§é—®é¢˜ <a class="header-anchor" href="#äº”ã€å¼€æ”¾æ€§é—®é¢˜" aria-label="Permalink to &quot;äº”ã€å¼€æ”¾æ€§é—®é¢˜&quot;">â€‹</a></h2><p>åªä½¿ç”¨ä¸€çº§ç¼“å­˜ï¼Œå’Œä¸‰çº§ç¼“å­˜æ˜¯å¦å°±èƒ½è§£å†³å¾ªç¯ä¾èµ–ï¼Œå¹¶ä¸”æ»¡è¶³beanä¸€äº›ç‰¹æ®Šé€»è¾‘å¤„ç†å‘¢ï¼ˆeg:aopï¼‰?</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String beanName, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> allowEarlyReference) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// Quick check for existing instance without full singleton lock</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		Object singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.singletonObjects.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isSingletonCurrentlyInCreation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.earlySingletonObjects.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> allowEarlyReference) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				synchronized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.singletonObjects) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">					// Consistent creation of early reference within full singleton lock</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.singletonObjects.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">					if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">						singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.earlySingletonObjects.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">						if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">							ObjectFactory&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; singletonFactory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.singletonFactories.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">							if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (singletonFactory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">								singletonObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> singletonFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">								this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.earlySingletonObjects.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName, singletonObject);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">								this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.singletonFactories.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">							}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">						}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> singletonObject;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>å°ç¼–å›ç­”: ä»…ä»…ä½¿ç”¨1çº§ç¼“å­˜å’Œ3çº§ç¼“å­˜å®Œå…¨å¯ä»¥çš„ã€‚</p><p>ä¹‹æ‰€ä»¥ä½¿ç”¨2çº§ç¼“å­˜æ˜¯å› ä¸ºä¸‰çº§ç¼“å­˜æ˜¯ObjectFactory#getObject()ã€‚æ˜¯æ¯æ¬¡éƒ½ä»å·¥å‚é‡Œé¢å»æ‹¿ã€‚è€Œä½¿ç”¨äº†2çº§ç¼“å­˜ï¼Œä»…ä»…æ˜¯ä¸ºäº†æé«˜æ€§èƒ½ã€‚ è€Œè®¾è®¡çš„ã€‚æ‰€ä»¥ä¸€å•è¿™ä¸ªå•ä¾‹Beanå®Œæˆåã€‚ä¼šé‡Œé¢æŠŠäºŒçº§å’Œä¸‰çº§ç¼“å­˜ç»™ç§»é™¤æ‰ã€‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> addSingleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String beanName, Object singletonObject) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		synchronized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.singletonObjects) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">			this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.singletonObjects.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName, singletonObject);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">			this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.singletonFactories.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">			this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.earlySingletonObjects.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">			this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.registeredSingletons.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div>`,83),h=[l];function p(k,e,E,r,g,d){return a(),i("div",null,h)}const o=s(t,[["render",p]]);export{c as __pageData,o as default};
